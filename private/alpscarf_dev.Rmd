---
title: "Alpscarf_dev"
output: html_document
---
```{r setup, echo = FALSE}
# The following code loads package (and install them if not exist).
## The "pacman" package automatically install missing packages and load them
if (!require("pacman")) install.packages("pacman", repos='https://stat.ethz.ch/CRAN/'); library(pacman)
p_load(
  tidyr,      # collection of the tidyverse packages:
  dplyr,      #   - for data wrangling
  tibble,     #   - a stricter alternative to data.frame
  ggplot2,    #   - for plotting
  cowplot    # adds plot_grid() to put multiple ggplot()'s togeter
)

import::from(magrittr, "%<>%")
library(alpscarf)
```

```{r get dataset, echo = FALSE}
# specify dataset name & path
dataset_path = "../data"
example_dataset <- file.path(dataset_path, "reduced_dwell.RData")
expected_aoi_sequence <- file.path(dataset_path, "aoi_sequence.RData")

# load data  
load(example_dataset)
load(expected_aoi_sequence)

# put AOIs in sorted order
aoi_names_pages_seq %<>%
  arrange(AOI_order)
```

```{r Kai's playground of Alpscarf}
# define colors
# MUST be 1-to-1 mapping; i.e., n AOIs would require n colors
my_palette <- 
  aoi_names_pages_seq$color[]

# generate Alpscarf dataset; 
# 1. calculate the confomity/revisiting scores and translate them into bar height
# 2. calculate the position of bars where bar width equals dewll duration
lsa_reduced_dwell_alp_df <- 
  lsa_reduced_dwell_df %>%
  alpscarf_height_trans(., aoi_names_pages_seq) %>%
  alpscarf_width_trans()

# generate stats of Alpscarf; NOT required in generating Alpscarf.
stat_table_df <- alpscarf_calculate_statistics(lsa_reduced_dwell_alp_df, aoi_names_pages_seq)

# plot Alpscarf
# in this example, we generate one Alpscarf for all participants in the given dataset.
# TODO: annotation (creeks)

# initialise the list storing Alpscarfs, one plot per participant
lsa_scarf_vis <- list()
# specify plot height
plot_height <- max(lsa_reduced_dwell_alp_df$seq_bar_length)
for(a_p_name in unique(lsa_reduced_dwell_alp_df$p_name)){
  df_p <-
    lsa_reduced_dwell_alp_df %>%
    filter(p_name == a_p_name) 
  
  # for indexing
  a_p_nr <- 
    strsplit(a_p_name,"P")[[1]][2] %>%
    as.numeric()
  
  # # generate info for annotation
  # df_p_temp %<>%
  #   # hightlight graph_AOI & no_special_behavior
  #   mutate(graph_AOI = if_else(AOI %in% c("G1_SUBJ", "G2_OBJ", "G3_DIFF"), 0, NULL),
  #          spatial_order_following = if_else(conformity_score > 0, TRUE, FALSE),
  #          re_reading = if_else(revisiting_score > 0, TRUE, FALSE),
  #          no_order_follow_nor_re_reading = if_else(!spatial_order_following & !re_reading, 0, NULL))
  
  # specify the color association of AOIs
  aoi_name_in_order <- 
    aoi_names_pages_seq$AOI[]
  df_p$AOI <- factor(df_p$AOI, levels = aoi_name_in_order)
  
  # Alpscarf plot generation
  # below is an example generates "Alpscarf"" in "transition-focus" mode. One can also generate Alpscarf in duration-focus mode, or even traditional scarf plot.
  # "max_y_value" specify the height of each plot. To make all Alpscarf comparable, generating Alpscarfs in the same height is highly recommended.
  lsa_scarf_vis[[a_p_nr]] <- alpscarf_plot_gen(df_p, my_palette, TRANSITION_FOCUS = FALSE, ALPSCARF_EN = TRUE,  max_y_value = plot_height)
}

# plot Alpscarf for all participants
plot_grid(lsa_scarf_vis[[7]], lsa_scarf_vis[[14]], lsa_scarf_vis[[11]], lsa_scarf_vis[[17]], lsa_scarf_vis[[15]], lsa_scarf_vis[[5]], lsa_scarf_vis[[1]], lsa_scarf_vis[[13]], lsa_scarf_vis[[16]], lsa_scarf_vis[[6]], lsa_scarf_vis[[4]], lsa_scarf_vis[[10]], lsa_scarf_vis[[12]], lsa_scarf_vis[[2]], lsa_scarf_vis[[3]], lsa_scarf_vis[[18]], lsa_scarf_vis[[8]], align = "hv", ncol = 2)
ggsave(file = "temp.png", plot = last_plot(), width = 49, height = 49, device = "png", bg = "transparent")
```
